conda activate /usr/local/community/Genomics/apps/mambaforge/envs/salmon

#Try aligning to OUR merged transcriptome created using StringTie (we used to make this as part of the ONT protocol anyway).
mkdir gtfFiles
find MinimapStringtieOutput/ -name '*.gtf' -exec cp -r {} gtfFiles/ \;
cd gtfFiles
ls >> vitc_gtfFiles.txt

#Copy dmel-all-r6.32.gtf to fastdata
------------------------------
#Script to submit:
#StringtieMergeScriptGracieVitC220224.sh

#!/bin/bash
# Request 8 gigabytes of real memory (RAM) 2 cores *4G = 8
#SBATCH --mem=8G
# Request 2 cores
#SBATCH --cpus-per-task=2
# Email notifications
#SBATCH --mail-user=gadams3@sheffield.ac.uk
# Email notifications if the job fails
#SBATCH --mail-type=ALL
# Change job output log file name (default is slurmJOBID)
#SBATCH --output=output.StringtieMergeVitC_221024.out
# Request more time (default is 8 hours)
#SBATCH --time=24:00:00

#Activate the repository
#echo -e "if [[ -e '/usr/local/extras/Genomics' ]];\nthen\n\tsource /usr/local/extras/Genomics/.bashrc\nfi" >> $HOME/.bash_profile
source /usr/local/extras/Genomics/.bashrc

# Set the OPENMP_NUM_THREADS environment variable to 4
# This is needed to ensure efficient core usage.
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

#StringTie to merge into our transcriptome
cd gtfFiles
stringtie --merge -p 2 -o vitc_stringtie_merged.gtf -G /fastdata/bop23ga/Gracie_VitC_220224/dmel-all-r6.32.gtf vitc_gtfFiles.txt
------------------------------

#On Ubuntu
#Convert this merged gtf to fasta on Ubuntu using gffread
../gffread/gffread -w vitc_stringtie_merged.fasta -g Drosophila_melanogaster.BDGP6.32.dna.toplevel.fa vitc_stringtie_merged.gtf
#Copy back to nanopore_output folder on Z drive

#On fastdata
#See this Q and further links to ONT pipeline on GitHub/for salmon: https://github.com/COMBINE-lab/salmon/issues/790
------------------------------
#Script to submit:
#MinimapOURTransScriptGracieVitC220224.sh

#!/bin/bash
# Request 8 gigabytes of real memory (RAM) 2 cores *4G = 8
#SBATCH --mem=8G
# Request 2 cores
#SBATCH --cpus-per-task=2
# Email notifications
#SBATCH --mail-user=gadams3@sheffield.ac.uk
# Email notifications if the job fails
#SBATCH --mail-type=ALL
# Change job output log file name (default is slurmJOBID)
#SBATCH --output=output.MinimapOURTranscVitC_241024.out
# Request more time (default is 8 hours)
#SBATCH --time=24:00:00

#Activate the repository
#echo -e "if [[ -e '/usr/local/extras/Genomics' ]];\nthen\n\tsource /usr/local/extras/Genomics/.bashrc\nfi" >> $HOME/.bash_profile
source /usr/local/extras/Genomics/.bashrc

# Set the OPENMP_NUM_THREADS environment variable to 4
# This is needed to ensure efficient core usage.
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

SampleArray=$(cat /fastdata/bop23ga/Gracie_VitC_220224/GracieVitC220224Conf.conf)

for g in ${SampleArray[@]}
do
#Aligment to transcripome using minimap2
minimap2 -ax map-ont -p 1.0 -N 100 /fastdata/bop23ga/Gracie_VitC_220224/gtfFiles/vitc_stringtie_merged.fasta /fastdata/bop23ga/Gracie_VitC_220224/fastq_pass/${g}_merge_trimmed.fastq > /fastdata/bop23ga/Gracie_VitC_220224/MinimapOURTransOutput/${g}_OURTrans.sam
#-a is for long reads, -x default is map-ont which is for long noisy reads. We usually do -x splice, but try -ax map-ont here to see if the error calculations help with the read length issues in salmon.
#-p sets minimum secondary to primaru score ratio, -N limits number of reported secondary alignments (from https://combine-lab.github.io/salmon-tutorials/2021/ont-long-read-quantification/)
done
------------------------------

#Potential issue with gtf file? See https://github.com/alexdobin/STAR/issues/1140

TRY FOLLOWING https://github.com/epi2me-labs/wf-transcriptomes
salmon quant --noErrorModel -t gtfFiles/vitc_stringtie_merged.fasta -l A -a MinimapOURTransOutput/barcode13_OURTrans.sam -o salmon_quant

#FIRST TRIED from this: https://gist.github.com/mikelove/922c323a7ae02ac5cedd9d1b3019e0fb
salmon quant --ont --noLengthCorrection -t gtfFiles/vitc_stringtie_merged.fasta -l U -a MinimapOURTransOutput/barcode13_OURTrans.sam -o salmon_quant
salmon quant --ont --noLengthCorrection -t gtfFiles/vitc_stringtie_merged.fasta -l U -a MinimapOURTransOutput_splicesetting/barcode13_OURTrans.sam -o salmon_quant
