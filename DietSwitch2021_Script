#Combined the fastq files for each barcode as usual, then renamed them sample names for ease and trimmed barcodes using Dorado (see: https://github.com/GracieAdams329/ONT-RNASeq-Pipeline/blob/main/Step1-combine-trim-fastq)
#Then run:
SCRIPT NAME: MinimapStringtieSalmonScript_DS2021.sh
-------
#!/bin/bash
# Request 8 gigabytes of real memory (RAM) 2 cores *4G = 8
#SBATCH --mem=8G
# Request 2 cores
#SBATCH --cpus-per-task=2
# Email notifications
#SBATCH --mail-user=gadams3@sheffield.ac.uk
# Email notifications
#SBATCH --mail-type=ALL
# Change job output log file name (default is slurmJOBID)
#SBATCH --output=output.MinimapStringtieSalmonDS2021_021224.out
# Request more time (default is 8 hours)
#SBATCH --time=24:00:00

#Activate the repository
#echo -e "if [[ -e '/usr/local/extras/Genomics' ]];\nthen\n\tsource /usr/local/extras/Genomics/.bashrc\nfi" >> $HOME/.bash_profile
source /usr/local/extras/Genomics/.bashrc

# Set the OPENMP_NUM_THREADS environment variable to 4
# This is needed to ensure efficient core usage.
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK

SampleArray=$(cat /fastdata/bop23ga/DietSwitch2_8_2021/samplelist.txt)

for g in ${SampleArray[@]}
do
#Aligment to genome using minimap2
minimap2 -ax splice /shared/simons_lab1/Shared/nanopore_output/Genomes_and_Transcriptomes/Drosophila_melanogaster.BDGP6.32.dna.toplevel.fa /fastdata/bop23ga/DietSwitch2_8_2021/fastq_TOUSE/${g}_merge_trimmed.fastq | samtools view -Sb > /fastdata/bop23ga/DietSwitch2_8_2021/MinimapOut/${g}.bam
samtools sort -@ 2 -m 4G -o /fastdata/bop23ga/DietSwitch2_8_2021/MinimapOut/${g}_sorted.bam /fastdata/bop23ga/DietSwitch2_8_2021/MinimapOut/${g}.bam
done

for g in ${SampleArray[@]}
do
#StringTie to assemble transcripts into a transcriptome according to the gene info from the genome
stringtie -p 2 -B -L -e -G /shared/simons_lab1/Shared/nanopore_output/Genomes_and_Transcriptomes/Drosophila_melanogaster.BDGP6.32.103.gtf -o /fastdata/bop23ga/DietSwitch2_8_2021/Stringtie_e_option/${g}/${g}_stringtie.gtf /fastdata/bop23ga/DietSwitch2_8_2021/MinimapOut/${g}_sorted.bam
done

for g in ${SampleArray[@]}
do
#Aligment to transcriptome using minimap2 for salmon
minimap2 -ax splice /shared/simons_lab1/Shared/nanopore_output/Genomes_and_Transcriptomes/Drosophila_melanogaster.BDGP6.32.cdna.all.fa /fastdata/bop23ga/DietSwitch2_8_2021/fastq_TOUSE/${g}_merge_trimmed.fastq | samtools view -Sb > /fastdata/bop23ga/DietSwitch2_8_2021/MinimapCDNAOut/${g}.bam
done

source /usr/local/community/Genomics/apps/miniconda/etc/profile.d/conda.sh
conda activate /usr/local/community/Genomics/apps/mambaforge/envs/salmon

for g in ${SampleArray[@]}
do
#Get read counts with salmon
salmon quant --ont -t /shared/simons_lab1/Shared/nanopore_output/Genomes_and_Transcriptomes/Drosophila_melanogaster.BDGP6.32.cdna.all.fa -l U -a /fastdata/bop23ga/DietSwitch2_8_2021/MinimapCDNAOut/${g}.bam -o /fastdata/bop23ga/DietSwitch2_8_2021/SalmonOut/${g}_salmonout/
done
-------

#The .ctab file made by StringTie to be used with the Ballgown R package use FPKM, whereas we want TPM (https://www.rna-seqblog.com/rpkm-fpkm-and-tpm-clearly-explained/) which is in the .gtf file.

cd /fastdata/bop23ga/DietSwitch2_8_2021/
barclist=$(cat samplelist.txt)

#Note that for the below code, if copied and pasted as a block it throws an error - make sure to type/copy and paste the individual lines!
for g in ${barclist[@]}
do
cd Sringtie_e_option/${g}
grep -P "\ttranscript\t" ${g}_stringtie.gtf | cut -f9 | grep -P "FBtr" | awk '{gsub("\"","",$0);gsub(";","",$0);print $4,$11,$12}' > ../TPMFiles/${g}_TPM.txt
cd /fastdata/bop23ga/DietSwitch2_8_2021/
done

#In MinimapOut folder
samplist=$(cat ../samplelist.txt)
for g in ${samplist[@]}
do
samtools flagstat ${g}.bam >${g}_flagstat.txt
done

#Copy across to shared drive:
- merged and trmmed fastq
- minimap outs
- salmon outs
____________________________________________________________________________________________________________________________________________________________________________________
R SCRIPT: SalmonvsStringtieTPM.R
-------
rm(list=ls())

library(tidyverse)
library(corrplot)
library(cluster)







# ##-------Checking method works for comparing one sample
# #Read in TPM from Salmon and StringTie
# setwd('Z:/simons_lab1/Shared/nanopore_output/DietSwitch2_8_2021/')
# 
# salmon <- read.table('SalmonOut/Sample001_salmonout/quant.sf', header = TRUE)
# salmon <- salmon[ -c(2, 3, 5)]
# colnames(salmon)[colnames(salmon) == "TPM"] <- "SalmonTPM"
# 
# stringtie <- read.table('Stringtie_e_option/TPMFiles/Sample001_TPM.txt', fill = TRUE)
# stringtie <- stringtie[ -2]
# colnames(stringtie)[colnames(stringtie) == "V1"] <- "Name"
# colnames(stringtie)[colnames(stringtie) == "V3"] <- "StringtieTPM"
# 
# TPM <- merge(salmon, stringtie, by = "Name")
# 
# #Explore the data
# ggplot(TPM, aes(x = SalmonTPM, y = StringtieTPM)) +
#   geom_point()
# 
# TPM$Salmon_over_Stringtie = TPM$SalmonTPM/TPM$StringtieTPM
# ggplot(TPM, aes(x = Name, y = Salmon_over_Stringtie)) +
#   geom_point()
# 
# TPM$logSalmonTPM = log10(TPM$SalmonTPM)
# TPM$logStringtieTPM = log10(TPM$StringtieTPM)
# ggplot(TPM, aes(x = logSalmonTPM, y = logStringtieTPM)) +
#   geom_point()
# 
# TPM$logSalmon_over_logStringtie = TPM$logSalmonTPM/TPM$logStringtieTPM
# ggplot(TPM, aes(x = Name, y = logSalmon_over_logStringtie)) +
#   geom_point()
# 
# #Correlation plots
# chart.Correlation(TPM[,2:3], histogram=TRUE)







##-------Loop to read in all samples and make a large dataframe for correlation plots
setwd('Z:/simons_lab1/Shared/nanopore_output/DietSwitch2_8_2021/')
samplelist <- read.table("samplelist_69.txt")
samplelist = samplelist$V1

#Make transcripts variable to store all transcripts in all samples
transcripts <- character()

for(i in 1:length(samplelist))
{
  currentsample = samplelist[i]
  
  salmon <- read.table(paste('SalmonOut/', currentsample, '_salmonout/quant.sf', sep = ''), header = TRUE, fill = TRUE)
  salmon <- salmon[ -c(2, 3, 5)]
  colnames(salmon)[colnames(salmon) == "TPM"] <- "SalmonTPM"
  
  stringtie <- read.table(paste('Stringtie_e_option/TPMFiles/', currentsample, '_TPM.txt', sep = ''), fill = TRUE)
  stringtie <- stringtie[ -2]
  colnames(stringtie)[colnames(stringtie) == "V1"] <- "Name"
  colnames(stringtie)[colnames(stringtie) == "V3"] <- "StringtieTPM"
  
  TPM <- merge(salmon, stringtie, by = "Name")
  
  #Fetch the transcripts from this sample's TPM dataframe
  transcripts <- append(transcripts, TPM$Name)
}

#Fetch unique transcripts out and make dataframe for merging
overallTPM <- as.data.frame(unique(transcripts))
colnames(overallTPM)[colnames(overallTPM) == "unique(transcripts)"] <- "Name"

stdups <- character()

#Run loop to merge for all samples
for(i in 1:length(samplelist))
{
  currentsample = samplelist[i]
  
  salmon <- read.table(paste('SalmonOut/', currentsample, '_salmonout/quant.sf', sep = ''), header = TRUE, fill = TRUE)
  salmon <- salmon[ -c(2, 3, 5)]
  colnames(salmon)[colnames(salmon) == "TPM"] <- "SalmonTPM"
  salmon <- subset(salmon, SalmonTPM > 0)
  salmon$logSalmonTPM <- log10(salmon$SalmonTPM)
  salmon <- salmon[ -2]
  
  stringtie <- read.table(paste('Stringtie_e_option/TPMFiles/', currentsample, '_TPM.txt', sep = ''), fill = TRUE)
  stringtie <- stringtie[ -2]
  colnames(stringtie)[colnames(stringtie) == "V1"] <- "Name"
  colnames(stringtie)[colnames(stringtie) == "V3"] <- "StringtieTPM"
  stringtie <- subset(stringtie, StringtieTPM > 0)
  stringtie$logStringtieTPM <- log10(stringtie$StringtieTPM)
  stringtie <- stringtie[ -2]
  
  stdups <- append(stdups, length(which(duplicated(stringtie$Name))))
  
  #Remove lowest and highest 5% of reads
  sal_quantile <- quantile(salmon$logSalmonTPM, c(0.05, 0.95))
  sal_quantile
  salmon <- salmon[salmon$logSalmonTPM > sal_quantile[1] &
                     salmon$logSalmonTPM < sal_quantile[2], ]
  
  st_quantile <- quantile(stringtie$logStringtieTPM, c(0.05, 0.95))
  st_quantile
  stringtie <- stringtie[stringtie$logStringtieTPM > st_quantile[1] &
                           stringtie$logStringtieTPM < st_quantile[2], ]
  
  TPM <- merge(salmon, stringtie, by = "Name")
  colnames(TPM)[colnames(TPM) == "logSalmonTPM"] <- paste("logSalmonTPM_", currentsample, sep = "")
  colnames(TPM)[colnames(TPM) == "logStringtieTPM"] <- paste("logStringtieTPM_", currentsample, sep = "")
  
  overallTPM <- left_join(overallTPM, TPM, by = "Name", keep = FALSE, multiple = "first")
  #Just takes the first value for the duplicated transcripts - must be an error in StringTie but it's in so few transcripts we can ignore for now.
}

#Convert gene name to rownames
overallTPM <- column_to_rownames(overallTPM, var = "Name")

stdups
#To check how many duplications there were - should be very few.







##-------Investigating how the samples correlate
setwd('Z:/simons_lab1/Shared/nanopore_output/DietSwitch2_8_2021/DietSwitch2_8_2021_R/')
#Ready to save plots etc.

corrtable <- cor(overallTPM, use = "complete.obs")
#This produces a similarity matrix, as the similar values are 1. A dissimilarity matrix is the opposite!

TPMagnes <- agnes(x = corrtable, diss = FALSE)
plot(TPMagnes, which.plots = 2, main = "Dendrogram of Salmon and StringTie TPM value clustering", sub = "TPMs for each transcript correlated using cor then clustered with agnes")
#This gives a dendrogram showing Salmon and StringTie seem to cluster with themselves.
#Save as png.

#To look at correlation values from cor:
ODD <- seq(from = 1, to = 138, by = 2)
EVEN <- seq(from = 2, to = 138, by = 2)

#Correlations visualised with corrplot
pdf("corrplots_Salmon_StringTie_TPM_correlations_minus5and95p.pdf", width = 33, height = 33)
corrplot(corrtable[ODD,ODD], method = "number")
corrplot(corrtable[EVEN,EVEN], method = "number")
corrplot(corrtable[ODD,EVEN], method = "number")
dev.off()

#Correlation histograms for entire similarity matrix
salmean <- round(mean(corrtable[ODD,ODD], na.rm = TRUE), digits = 3)
stmean <- round(mean(corrtable[EVEN,EVEN], na.rm = TRUE), digits = 3)
bothmean <- round(mean(corrtable[ODD,EVEN], na.rm = TRUE), digits = 3)

salmed <- round(median(corrtable[ODD,ODD], na.rm = TRUE), digits = 3)
stmed <- round(median(corrtable[EVEN,EVEN], na.rm = TRUE), digits = 3)
bothmed <- round(median(corrtable[ODD,EVEN], na.rm = TRUE), digits = 3)

pdf("histogram_Salmon_StringTie_TPM_correlations_minus5and95p.pdf", width = 10, height = 10)
hist(corrtable[ODD,ODD], main = "Histogram of correlation coefficients for Salmon vs Salmon TPMs",  sub = paste("mean =", salmean, "median =", salmed, sep = " "))
hist(corrtable[EVEN,EVEN], main = "Histogram of correlation coefficients for StringTie vs StringTie TPMs", sub = paste("mean =", stmean, "median =", stmed, sep = " "))
hist(corrtable[ODD,EVEN], main = "Histogram of correlation coefficients for Salmon vs StringTie TPMs", sub = paste("mean =", bothmean, "median =", bothmed, sep = " "))
dev.off()

#To get the off-diagonal matrix only:
offdiagcorr <- corrtable
offdiagcorr[lower.tri(offdiagcorr, diag = TRUE)] <- NA

salmean <- round(mean(offdiagcorr[ODD,ODD], na.rm = TRUE), digits = 3)
stmean <- round(mean(offdiagcorr[EVEN,EVEN], na.rm = TRUE), digits = 3)
bothmean <- round(mean(offdiagcorr[ODD,EVEN], na.rm = TRUE), digits = 3)

salmed <- round(median(offdiagcorr[ODD,ODD], na.rm = TRUE), digits = 3)
stmed <- round(median(offdiagcorr[EVEN,EVEN], na.rm = TRUE), digits = 3)
bothmed <- round(median(offdiagcorr[ODD,EVEN], na.rm = TRUE), digits = 3)

#Histogram of off-diagonal correlation coefficients (removes repeats and samples correlated to themselves)
pdf("histogram_Salmon_StringTie_TPM_correlations_uppertri_minus5and95p.pdf", width = 10, height = 10)
hist(offdiagcorr[ODD,ODD], main = "Histogram of off-diagonal correlation coefficients for Salmon vs Salmon TPMs", sub = paste("mean =", salmean, "median =", salmed, sep = " "))
hist(offdiagcorr[EVEN,EVEN], main = "Histogram of off-diagonal correlation coefficients for StringTie vs StringTie TPMs", sub = paste("mean =", stmean, "median =", stmed, sep = " "))
hist(offdiagcorr[ODD,EVEN], main = "Histogram of off-diagonal correlation coefficients for Salmon vs StringTie TPMs", sub = paste("mean =", bothmean, "median =", bothmed, sep = " "))
dev.off()







##-------Compare Salmon and StringTie counts per sample to minimap2 mapped reads
setwd('Z:/simons_lab1/Shared/nanopore_output/DietSwitch2_8_2021/')
samplelist <- read.table("samplelist_69.txt")

allcovsums <- data.frame(Sample = character(),
                            covsum = integer())

samplelist = samplelist$V1

#Loop to fetch sum(t_data.ctab$cov) (cov is per-base coverage for the transcript) for each sample
for(i in 1:length(samplelist))
{
  currentsample = samplelist[i]
  tdat <- read.table(paste('Stringtie_e_option/', currentsample, '/t_data.ctab', sep = ''), header = TRUE, fill = TRUE)
  covsum <- as.data.frame(sum(tdat$cov))
  covsum$Sample = paste(currentsample)
  colnames(covsum)[colnames(covsum) == "sum(tdat$cov)"] <- "sumcov"
  covsum <- covsum[,c(2,1)]
  allcovsums <- rbind(allcovsums, covsum)
}

____________________________________________________________________________________________________________________________________________________________________________________
